
CREATE OR REPLACE FUNCTION uniswap_v3.insert_uniswap_v3_poolCreated(start_ts timestamptz, end_ts timestamptz=now(), start_block numeric=0, end_block numeric=9e18) RETURNS integer
LANGUAGE plpgsql AS $function$
DECLARE r integer;
BEGIN

INSERT INTO uniswap_v3.view_pools(
token0 bytea NOT NULL,
token1 bytea NOT NULL,
fee integer,
pool bytea PRIMARY KEY
)

SELECT "token0","token1", fee, pool FROM uniswap_v3."Factory_evt_PoolCreated" pc
WHERE NOT EXISTS (SELECT 1 FROM uniswap_v3.view_pools vp WHERE vp.pool = pc.pool LIMIT 1)

INSERT INTO cron.job (schedule, command)
VALUES ('27,57 * * * *', $$
    SELECT uniswap_v3.insert_uniswap_v3_poolCreated(
        '2021-11-11'::timestamptz,
        (SELECT now() - interval '20 minutes'),
        0,
        (SELECT MAX(number) FROM optimism.blocks where time < now() - interval '20 minutes')
        );
$$)
ON CONFLICT (command) DO UPDATE SET schedule=EXCLUDED.schedule;
